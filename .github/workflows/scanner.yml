name: Pre-Market Breakout Screen v2

on:
  workflow_dispatch:
  schedule:
    # 13:10 UTC = 8:10am US Eastern (adjust if needed)
    - cron: "10 13 * * 1-5"

jobs:
  run-screen:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Show repo contents (debug)
        run: |
          echo "PWD: $(pwd)"
          ls -la

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies (force websockets last)
        run: |
          python -m pip install --upgrade pip setuptools wheel
          # Core dependencies
          pip install yahoo_fin beautifulsoup4 html5lib lxml
          pip install "yfinance==0.2.40" pandas numpy ta requests
          # Fix websockets compatibility
          pip install --upgrade --force-reinstall "websockets==11.0.3"
          # Quick sanity check
          python - <<'PY'
          import websockets, yfinance
          print("websockets:", websockets.__version__)
          print("yfinance:", yfinance.__version__)
          from websockets.sync.client import connect
          print("websockets.sync import OK âœ“")
          PY

      - name: Run v2 pre-market breakout screen (swing_scanner_v2.py)
        env:
          ADR_PERIOD: "14"
          MA_FAST: "10"
          MA_SLOW: "22"
          AVG_VOL_LOOKBACK: "30"
          RS_LOOKBACK_MONTHS: "6"
          HIGH_LOOKBACK_DAYS: "120"

          # --- Volatility + liquidity ---
          MIN_ADR_PCT: "4.0"        # was 5
          MAX_ADR_PCT: "16.0"       # was 12
          MIN_AVG_VOL_30D: "10000000"   # was 30000000 (much looser)
          MIN_PRICE: "1.0"

          # --- Relative strength ---
          MIN_RS_PCTILE: "0.95"     # was 0.98 (top 5% instead of top 2%)

          # --- Prefilter universe ---
          PREFILTER_MIN_PRICE: "3.0"
          PREFILTER_MIN_AVG_VOL5: "1000000"   # was 5,000,000
          PREFILTER_TOP_N_BY_DOLLAR_VOL: "2000"  # scan a bit more names

          # --- Base structure / extension ---
          MAX_BASE_DEPTH_PCT: "40"      # was 35
          MAX_DIST_FROM_HIGH_PCT: "12"  # was 8
          MAX_DIST_FROM_22SMA_PCT: "25" # was 15

          # --- VCP contraction window ---
          VCP_SHORT: "10"
          VCP_LONG: "40"
          MIN_VCP_RATIO: "0.15"   # was 0.2
          MAX_VCP_RATIO: "0.85"   # was 0.7

          TOP_N_TO_REPORT: "40"

          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID:   ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ ! -f "swing_scanner_v2.py" ]; then
            echo "::error ::swing_scanner_v2.py not found at repo root."
            exit 1
          fi
          python swing_scanner_v2.py

      - name: List files (debug)
        if: always()
        run: ls -la

      - name: Upload CSV artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: premarket-breakout-v2-results
          path: allus_breakout_v2_*.csv
