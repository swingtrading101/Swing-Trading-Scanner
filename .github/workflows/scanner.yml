name: Pre-Market ALL-US Screen

on:
  workflow_dispatch:        # manual runs
  schedule:
    # ~9:10 AM US Eastern (13:10 UTC) Monâ€“Fri
    - cron: "10 13 * * 1-5"

jobs:
  run-screen:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Show repo contents (debug)
        run: |
          echo "PWD: $(pwd)"
          ls -la

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          # Install websockets first so yfinance can import its live module safely
          pip install "websockets==11.0.3"
          # Core libs
          pip install "yfinance>=0.2.40" pandas numpy ta requests
          # yahoo_fin + HTML parsers
          pip install yahoo_fin beautifulsoup4 html5lib lxml

      - name: Run ALL-US pre-market screen (swing_scanner.py)
        env:
          # ------- Screening knobs -------
          ADR_PERIOD: "14"
          MA_PERIOD: "22"
          AVG_VOL_LOOKBACK: "30"
          RS_LOOKBACK_MONTHS: "6"

          # Hard filter thresholds
          MIN_ADR_PCT: "5"
          MIN_AVG_VOL_30D: "30000000"
          MIN_PRICE: "1.0"
          MIN_RS_PCTILE: "0.98"

          # Universe speed knobs
          PREFILTER_MIN_PRICE: "3.0"
          PREFILTER_MIN_AVG_VOL5: "5000000"
          PREFILTER_TOP_N_BY_VOL: "1200"

          # Telegram (repo secrets)
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID:   ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ ! -f "swing_scanner.py" ]; then
            echo "::error ::swing_scanner.py not found at repo root."
            exit 1
          fi
          python swing_scanner.py

      - name: List files (debug)
        if: always()
        run: ls -la

      - name: Upload CSV artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: premarket-screen-results
          path: allus_premarket_screen_*.csv
