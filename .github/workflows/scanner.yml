name: Pre-Market ALL-US Screen

on:
  workflow_dispatch:        # allow manual runs from Actions tab
  schedule:
    # ~9:10 AM US Eastern (13:10 UTC) Mon–Fri
    - cron: "10 13 * * 1-5"

jobs:
  run-screen:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Show repo contents (debug)
        run: |
          echo "PWD: $(pwd)"
          ls -la

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Core libs
          pip install yfinance pandas numpy ta scipy requests
          # yahoo_fin + parsers explicitly
          pip install yahoo_fin beautifulsoup4 html5lib lxml

      - name: Run ALL-US pre-market screen (swing_scanner.py)
        env:
          # ------- Tuning knobs (optional) -------
          ADR_PERIOD: "14"
          MA_PERIOD: "22"
          AVG_VOL_LOOKBACK: "30"
          RS_LOOKBACK_MONTHS: "6"

          # Hard filter thresholds
          MIN_ADR_PCT: "5"
          MIN_AVG_VOL_30D: "30000000"
          MIN_PRICE: "1.0"
          MIN_RS_PCTILE: "0.98"

          # Universe speed knobs
          PREFILTER_MIN_PRICE: "3.0"
          PREFILTER_MIN_AVG_VOL5: "5000000"
          PREFILTER_TOP_N_BY_VOL: "1200"

          # Use premarket/real-time price if available
          USE_PREMARKET_PRICE: "1"

          # Telegram secrets (add in repo Settings → Secrets and variables → Actions)
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ ! -f "swing_scanner.py" ]; then
            echo "::error ::Cannot find swing_scanner.py at repo root."
            ls -la
            exit 1
          fi
          python swing_scanner.py

      - name: Upload CSV artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: premarket-screen-results
          path: allus_premarket_screen_*.csv
